<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./styles/css/reset.css">
    <link rel="stylesheet" href="./styles/css/index.css">
    <script>

        class User {
            constructor(login, bornDate, password) {
                this.login = login;
                this.bornDate = bornDate;
                this.password = password;
            }
            static create(user) {
                return new User(user.login, user['date_born'], null)
            }
        }

        class UserServices {
            getAll() {
                return fetch(UserServices.BASE_URL + 'users')
                    .then(response => response.json())
                    .then(response => response.users)
                    .then(users => users.map(user => User.create(user)));
            }

            register(user) {
                return fetch(UserServices.BASE_URL + 'register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        login: user.login,
                        date_born: user.bornDate,
                        password: user.password
                    })
                }).then(response => response.json())
            }

            login(user) {
                return fetch(UserServices.BASE_URL + 'login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        login: user.login,
                        password: user.password
                    })
                }).then(response => response.json());
            }
        }

        UserServices.BASE_URL = 'https://mag-contacts-api.herokuapp.com/';

        class RegisterForm {
            constructor(selector, userService) {
                this.selector = selector;
                this.userService = userService;
                document.addEventListener('DOMContentLoaded', () => {
                    this.init();
                    this.bind();
                })
            }

            init() {
                this.container = document.querySelector(this.selector);
                this.loginInput = this.container.querySelector('#login-reg');
                this.bornInput = this.container.querySelector('#date_born-reg');
                this.passwordInput = this.container.querySelector('#password-reg');
                this.button = this.container.querySelector('.btn');
            }

            bind() {
                this.button.addEventListener('click', () => this.register())
            }

            register() {
                let user = new User(
                    this.loginInput.value,
                    this.bornInput.value,
                    this.passwordInput.value
                );
                this.userService.register(user).then(response => {
                    if (response.status == 'error')
                        this.registerError(response.error);
                    else this.succsessRegister();
                })

            }

            registerError(text) {
                alert(text);
            }

            succsessRegister() {
                this.clearForm();
                alert('Yahoo!!!');
            }

            clearForm() {
                this.loginInput.value = '';
                this.bornInput.value = '';
                this.passwordInput.value = '';
            }

        }

        class LoginForm {
            constructor(selector, userService) {
                this.selector = selector;
                this.userService = userService;
                document.addEventListener('DOMContentLoaded', () => {
                    this.init();
                    this.bind();
                })
            }

            init() {
                this.container = document.querySelector(this.selector);
                this.loginInput = this.container.querySelector('#login-log');
                this.passwordInput = this.container.querySelector('#password-log');
                this.button = this.container.querySelector('.btn');
            }

            bind() {
                this.button.addEventListener('click', () => this.login())
            }

            login() {
                let user = new User(
                    this.loginInput.value,
                    this.passwordInput.value
                );
                this.userService.login(user).then(response => {
                    console.log(response.status)
                    if (response.status == 'error')
                        this.loginError(response.error);
                    else this.succsessLogin();
                })
            }

            loginError(text) {
                alert(text);
            }

            succsessLogin() {
                alert('Yahooeeee!!!');
            }
        }

        let userService = new UserServices();
        //userService.getAll().then(u => console.log(u));
        //userService.login(new User('deimos', null, 'qwerty')).then(r => console.log(r));
        let registerForm = new RegisterForm('.register', userService);
        let loginForm = new LoginForm('.login', userService);
    </script>
</head>

<body>
    <div class="wrapper">
        <div class="title">
            <p>my phone book</p>
            <button class="btn btn-exit">Exit</button>
        </div>
        <div class="container">
            <div class="register">
                <h2>
                    registration
                </h2>
                <div class="form-control">
                    <input type="text" class="input" id="login-reg" placeholder="Login">
                </div>

                <div class="form-control">
                    <input type="text" class="input" id="date_born-reg" placeholder="Birth date">
                </div>

                <div class="form-control">
                    <input type="password" class="input" id="password-reg" placeholder="Password">
                </div>

                <div class="form-control btn-pos">
                    <button class="btn">register</button>
                </div>
            </div>

            <div class="login">
                <h2>
                    login
                </h2>
                <div class="form-control">
                    <input type="text" class="input" id="login-log" placeholder="Login">
                </div>

                <div class="form-control">
                    <input type="password" class="input" id="password-log" placeholder="Password">
                </div>

                <div class="form-control btn-pos">
                    <button class="btn btn-login">login</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>